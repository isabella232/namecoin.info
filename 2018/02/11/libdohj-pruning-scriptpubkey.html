<!DOCTYPE html>
<html class="nojs">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Pruning of Non-scriptPubKey Data in libdohj</title>
    <!--<meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">-->

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
    /* Work in progress, created by Ben <dotbitgod@gmail.com>. */

body {
    background: #F7F7F7;
    background: #292e3c;
    font-size: 18px;
    font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
    word-wrap: break-word;
}

body > header {
    background: #999;
}

.lead {
    font-size: 1.9em;
}

h2 {
    font-size: 1.2em;
    font-weight: bold;
    color: #495f7e;
}

body > footer {
    background: #292e3c url(/images/fancy.jpg) center bottom;
    height: 99px;
}

body > footer > .container, body > footer > .container-fluid {
    opacity: 0.6;
    padding-top: 33px;
}


body > footer a, body > footer a:hover {
    color: #FFF;
}

nav ul li {
    display: inline;
}

#fancy-graphic {
    height: 350px;
    background: #292e3c url(/images/fancy.jpg) center top fixed;
    padding-top: 125px;
}

#fancy-graphic p {
    font-size: 4em;
    font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
    color: #FFF;
    margin: 0px 0px 0px 40px !important;
    line-height: 1;
    text-shadow: 1px 1px 1px #000;
    opacity: 0.6;
    position: fixed;
    z-index: 0;
}

@media (max-width: 549px) {
  #fancy-graphic {
    height: 262.5px;
    padding-top: 93.75px;
  }
  
  #fancy-graphic p {
    font-size: 3em;
  }
}

@media (max-width: 399px) {
  #fancy-graphic {
    height: 218.75px;
    padding-top: 78.125px;
  }
  
  #fancy-graphic p {
    font-size: 2.5em;
  }
}

#content {
    position: relative;
    z-index: 9;
    background: #F7F7F7;
    padding: 40px;
}

table {
    border-collapse: collapse;
}

td, th {
    border: 1px solid #999;
    padding: 0.5em;
}

*[id]:before {
    display: block;
    content: " ";
    margin-top: -51px;
    height: 51px;
    visibility: hidden;
}

/* TODO: refactor this */
@media (max-width: 1003px) and (min-width: 768px) {
    *[id]:before {
        display: block;
        content: " ";
        margin-top: -101px;
        height: 101px;
        visibility: hidden;
    }
}


/* Begin nojs */

html.nojs .dropdown-toggle:focus + .dropdown-menu, html.nojs .dropdown-toggle:active + .dropdown-menu, html.nojs .dropdown-menu:focus, html.nojs .dropdown-menu:active, html.nojs .dropdown-menu:hover {
    display: block;
}

html.nojs .navbar-header {
    float: left;
}
@media (max-width: 767px) {
    html.nojs .navbar-toggle:focus + .collapse, html.nojs .navbar-toggle:active + .collapse, html.nojs .collapse:focus, html.nojs .collapse:active, html.nojs .collapse:hover {
        display: block;
    }
    
    html.nojs .collapse {
        padding-top: 2em;
        max-height: none;
    }
    
    html.nojs .dropdown-menu {
        float: none;
        position: static;
    }
}
@media (min-width: 768px) {
}

/* End nojs */

    </style>
    
    <link rel="canonical" href="https://namecoin.org//2018/02/11/libdohj-pruning-scriptpubkey.html">
    <link rel="alternate" type="application/rss+xml" title="Namecoin News" href="/feed.rss"/>
</head>


  <body>

    <header class="site-header">

        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/"><img src="/images/logo.png" alt="Namecoin" /></a>
                </div>
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse" tabindex="">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <div class="navbar-collapse collapse" id="navbar-collapse">
                <ul class="nav navbar-nav navbar-left">
                    <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" tabindex="">Get Started</a>
                        <ul class="dropdown-menu">
                            <li><a href="/download/">Download</a></li>
                            <li><a href="/get-started/get-namecoins/">Get Namecoins</a></li>
                            <li><a href="/docs/name-owners/">Docs for Domain Owners</a></li>
                        </ul>
                    </li>
                    <li><a href="/docs/faq/">FAQ</a></li>
                    <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" tabindex="">Resources</a>
                        <ul class="dropdown-menu">
                            <li><a href="/resources/chat/">Matrix/IRC Chat</a></li>
                            <li><a href="https://forum.namecoin.org">Forum&#10138;</a></li>
                            <li><a href="/resources/presentations/">Presentations</a></li>
                            <li><a href="/explorers/">Explorers</a></li>
                            <li><a href="https://wiki.namecoin.org">Wiki&#10138;</a></li>
                            <li><a href="https://github.com/namecoin/meta/blob/master/roadmap.md">Roadmap&#10138;</a></li>
                        </ul>
                    </li>
                    <li><a href="/team/">Team</a></li>
                    <li><a href="/news/">News</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/contribute/">Contribute</a></li>
                </ul>
                </div>
            </div>
        </nav>

</header>

<div id="fancy-graphic"><div class="container-fluid"><p id="tagline">
<noscript>
Decentralized<br /><strong>secure</strong> names.
</noscript>
</p></div></div>


    <div id="content">
      <div class="container-fluid">
        























































































































































<div class="post">

<header class="post-header">
<h1 class="post-title">Pruning of Non-scriptPubKey Data in libdohj</h1>
<p class="post-meta">Feb 11, 2018 • Jeremy Rand <i class="fa fa-tag"></i></p>
</header>

<article class="post-content">
<p>Our lightweight SPV client’s <code class="highlighter-rouge">leveldbtxcache</code> mode is the most secure of the various Namecoin lightweight SPV modes.  Its storage requirements aren’t too bad either (129.1 MB at the moment for Namecoin mainnet).  However, while 129.1 MB of storage isn’t a dealbreaker, it’s still a bit borderline on mobile devices.  We can do better.</p>

<p>First, a reminder of how <code class="highlighter-rouge">leveldbtxcache</code> currently works.  Initially, the IBD (initial blockchain download) proceeds the same way a typical lightweight SPV Bitcoin client (such as Schildbach’s Android Bitcoin Wallet) would work: it downloads blockchain headers, aiming for the chain with the most work.  However, at the point when the IBD has reached 1 year ago in the blockchain, it begins downloading full blocks instead of block headers.  The full blocks aren’t saved; they’re used temporarily for 2 purposes: verifying consistency with the block headers’ Merkle root (thus ensuring that no transactions have been censored), and adding any <code class="highlighter-rouge">name_anyupdate</code> transactions to a LevelDB database that allows quick lookup of names.  After those 2 things have been processed, the full blocks are discarded.  The 129.1 MB storage figure is as low as it is because we’re only storing name transactions from the last year (plus block headers, which are negligible in size).</p>

<p>However, there’s a lot of data in name transactions that we don’t actually need in order to look up names: currency data, signatures, and transaction metadata.</p>

<p>Currency data exists in name transactions because name operations cost a transaction fee, so there will typically be a currency input and a currency output in any name transaction.  We don’t need this information in order to look up names.  Signatures are used for verifying new transactions, but are not needed to look up previously accepted transaction data.  Transaction metadata, such as <code class="highlighter-rouge">nVersion</code> and <code class="highlighter-rouge">nLockTime</code>, is also not needed to look up names.  There may be other sources of unwanted data too.</p>

<p>To improve the situation, I’ve just modified <code class="highlighter-rouge">leveldbtxcache</code> so that, instead of storing full name transactions in LevelDB, it only stores the <code class="highlighter-rouge">scriptPubKey</code> of the name output.  This includes the name’s identifier and value, as well as the Bitcoin-compatible <code class="highlighter-rouge">scriptPubKey</code> that can be used to verify future signatures.  It’s a relatively straightforward change to the code, although it does break backward-compatibility with existing name databases (so you’ll need to delete your blockchain and resync after updating).</p>

<p>So, how does this fare?</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th><strong>Full Transactions</strong></th>
      <th><strong>Only <code class="highlighter-rouge">scriptPubKey</code></strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Storage Used after IBD</strong></td>
      <td>129.1 MB</td>
      <td>63.7 MB</td>
    </tr>
    <tr>
      <td><strong>Time Elapsed for IBD</strong></td>
      <td>~9 Minutes</td>
      <td>~6 minutes</td>
    </tr>
  </tbody>
</table>

<p>Not bad, and we even got a faster IBD as a bonus.  (This suggests that the bottleneck, at least on my laptop running Qubes with an HDD, was storage I/O.)</p>

<p>I’ve just submitted this change to upstream libdohj.</p>

<p>This work was funded by NLnet Foundation’s Internet Hardening Fund.</p>

</article>

</div>





















































































































































































































































      </div>
    </div>

    <footer class="site-footer">

        <div class="container-fluid" style="float:left;">
            <ul class="list-inline">
                <li><a href="https://github.com/namecoin"><i class="fa fa-github fa-2x" title="GitHub">GitHub</i></a></li>
                <li><a href="https://twitter.com/Namecoin"><i class="fa fa-twitter fa-2x" title="Twitter">Twitter</i></a></li>
                <li><a href="https://www.reddit.com/r/namecoin"><i class="fa fa-reddit-alien fa-2x" title="Reddit">Reddit</i></a></li>
                <li><a href="https://forum.namecoin.org/"><i class="fa fa-comments fa-2x" title="Forum">Forum</i></a></li>
            </ul>
        </div>

        <div class="container-fluid" style="float:right;">
	    <a href="https://github.com/namecoin/namecoin.org/blob/master/_posts/2018-02-11-libdohj-pruning-scriptpubkey.md"><i>Submit corrections or improvements to this page</i></a>
        </div>

        <script src="/js/jquery-1.11.0.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/script.js"></script>
        <script src="/js/remove-nojs.js"></script>
        
</footer>


  </body>

</html>
